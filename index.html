<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
        <title>Audio Analyser</title>
        <meta name="description" content="An audio tuner webapp">

        <style>

            body {
                font: 1em/1.3 monospace;
                padding: 1rem;
                background-color: hsl(100,75%,10%);
                color: hsl(100,75%,66%);
                text-align: center;
                display: flex;
                flex-flow: column nowrap;
                align-items: center;
                justify-content: space-around;
                text-shadow: 0 0 .5rem hsl(100,75%,66%);
            }

            h1 {
                max-width: 50vh;
                font-weight: normal;
                text-transform: uppercase;
                font-size: 2rem;
                margin: 1rem 0 0;
                padding: 0;
            }

            #canvas-soundinfo {
                width: 100%;
                height: 256px;
                border: solid 1px hsl(100,75%,33%);
                box-shadow: inset 0 0 .5rem hsl(100,75%,33%);
                margin: 1rem 0;
            }

            #pitch {
                width: 100%;
            }

            #pitch h2 {
                text-align: center;
            }

            #pitch-visualizer {
                text-align: center;
            }

            #hz-current {
                position: relative;
                background-color: hsl(100,75%,66%);
                color: hsl(100,75%,10%);
                padding: .5rem;
                border-radius: .5rem;
                width: 4rem;
                display: inline-block;
                transition: left .33s;
            }

        </style>
    </head>
    <body>

        <h1>Audio Analyser</h1>
        
        <div id="pitch">
            <h2>
                Target note<br>
                <span id="hz-target">Unknown key</span>
            </h2>
            <div id="pitch-visualizer">
                <span id="hz-current">- hz</span>
            </div>
        </div>

        <canvas id="canvas-soundinfo" height="256" width="2048"></canvas>

        <script>

            var notes = calcNotes(),
                current_note = notes[9],
                strong_pitch = [0,0,0,0],
                hz_target = document.getElementById('hz-target'),
                hz_current = document.getElementById('hz-current');


            function calcNotes() {
                var notes = [],
                    i = 1;
                for (var octave = 0; octave <= 8; octave++) {
                    // Calc sets of notes for 8 octaves
                    for (var halfnote = 1; halfnote <= 12; halfnote++ ) {
                        var note = {
                            key: '',
                            octave: octave,
                            hz: 0
                        };        
                        switch(halfnote) {
                            case 1:
                                note.key = 'C';
                                break;
                            case 2:
                                note.key = 'C#';
                                break;
                            case 3:
                                note.key = 'D';
                                break;
                            case 4:
                                note.key = 'Eb';
                                break;
                            case 5:
                                note.key = 'E';
                                break;
                            case 6:
                                note.key = 'F';
                                break;
                            case 7:
                                note.key = 'F#';
                                break;
                            case 8:
                                note.key = 'G';
                                break;
                            case 9:
                                note.key = 'Ab';
                                break;
                            case 10:
                                note.key = 'A';
                                break;
                            case 11:
                                note.key = 'A#';
                                break;
                            case 12:
                                note.key = 'B';
                                break;
                            default:
                                console.log('something went wrong');
                        };
                        note.hz = Math.round(Math.pow(2,((i-58)/12)) * 440);
                        notes.push(note);
                        i++;
                    };
                };
                console.log('An array of notes:');
                console.log(notes);
                return notes;
            };


            function initAudioContext(stream) {

                // create audio context and analyser
                var actx = new (window.AudioContext || window.webkitAudioContext)(), 
                    analyser = actx.createAnalyser(),
                    sample_rate = actx.sampleRate,
                    mic = actx.createMediaStreamSource(stream),
                    canvas = document.getElementById("canvas-soundinfo"),
                    ctx = canvas.getContext("2d"), // Get canvas context
                    cheight = canvas.height,
                    j = 0;

                
                // Connect microphone to analyser
                mic.connect(analyser);

                analyser.fftSize = 4096;
                ctx.fillStyle = 'white';

                var bufferLength = analyser.frequencyBinCount;
                var dataArray = new Uint8Array(bufferLength);

                function draw() {
                    requestAnimationFrame(draw);
                    analyser.getByteFrequencyData(dataArray);

                    ctx.clearRect(0,0,canvas.width, cheight);
                    for(var i = 0; i < bufferLength; i++) {
                        j = dataArray[i];
                        if (j > strong_pitch[0]) {
                            strong_pitch = [j,i,bufferLength,sample_rate];
                        };
                        ctx.fillRect(i,cheight,1,-j);
                        
                    };
                };

                // Visualise audio using analyser data
                draw();
            };

/*
            function calcNote(hz) {
                var n = Math.round(12*(Math.log2(hz/440))+57),
                    note = notes[n];
                return note;
            };


            function analysePitch(samples_arr) {
                samples_arr = samples_arr.sort( function(a,b) {return a - b;} );

                let idx = Math.floor(samples_arr.length/2),
                    median_hz = samples_arr[idx];
                if (idx > 0) {
                    visualizePitch(median_hz);
                }
                pitch_samples = [];
                setTimeout(function() {
                    analysePitch(pitch_samples);
                }, 1000);
            };
*/

            function visualizePitch() {
                const pitch = Math.floor( strong_pitch[1] * (strong_pitch[3]/2) / strong_pitch[2] );
                hz_current.innerHTML = pitch + 'hz';
                strong_pitch = [0,0,0,0];
                setTimeout(function() {
                    visualizePitch();
                }, 2000);
            };


            function checkWebAudioCapability() {
                if (navigator.mediaDevices) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            initAudioContext(stream);
                            visualizePitch();
                        })
                        .catch(function(err) {
                            console.log(err)
                        })
                };
            };


            checkWebAudioCapability();

        </script>

    </body>
</html>
